<?php

class Protection extends App_Controller
{
    public static $calculatorCategories = null;
    public static $types = null;
    public static $defaultActiveCategory = null;

    protected $globalHandlers = [
        "onOrderProtection"
    ];


    public function __construct()
    {
        $this->viewData['defaultActiveCategory'] = self::$defaultActiveCategory = 'phone';

        // –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤  
        self::$calculatorCategories = [
            'phone' => (object)['name' => '–°–º–∞—Ä—Ç—Ñ–æ–Ω—ã', 'hidden' => false],
            'tablet' => (object)['name' => '–ü–ª–∞–Ω—à–µ—Ç—ã', 'hidden' => false],
            'watch' => (object)['name' => '–°–º–∞—Ä—Ç-—á–∞—Å—ã', 'hidden' => false]
        ];

        $this->viewData['calculatorCategories'] = self::$calculatorCategories;

        // —Å–µ–≥–º–µ–Ω—Ç—ã
        self::$types =  [
            'premium' => (object)[
                'name' => '–ü—Ä–µ–º–∏—É–º',
                'icon' => 'üíé'
            ],
            'standart' => (object)[
                'name' => '–°—Ç–∞–Ω–¥–∞—Ä—Ç',
                'icon' => '‚≠ê'
            ],
            'base' => (object)[
                'name' => '–ë–∞–∑–æ–≤—ã–π',
                'icon' => '‚òòÔ∏è'
            ]


        ];


        // –¥–∞–Ω–Ω—ã–µ
        $this->viewData['calculatorSections'] = $this->getCalculatorData();

        parent::__construct();
    }

    public function index()
    {
        $this->layout = "__protection_layout";

        $this->viewData['brands'] = ['Sunshine', 'Hoco', 'Mietubl', 'Remax', 'Baseus'];
    }


    protected function onOrderProtection()
    {
        try {
            $inputJSON = file_get_contents('php://input');

            $data = json_decode($inputJSON, TRUE);

            $data_order = $data['data'];
            $cart = $data['cart'];

            $values['phone'] = $data_order['phone'];
            $values['author_name'] = $data_order['name'];
            $values['author_email'] = "noreplay@bb65.ru";
            $values['date'] = $data_order['date'];
            $values['comment'] = self::initListServices($cart);

            $dateOrderArr = explode('-', $values['date']);

            if ($dateOrderArr) {
                $date = new Phpr_DateTime();
                $date->setDate(abs($dateOrderArr[0]), abs($dateOrderArr[1]), abs($dateOrderArr[2]));
                $values['comment'] .= PHP_EOL  . "–î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏: " . $date->format('%e %B %Y');
            }

            if (!$this->validation->validate($values)) {
                $this->validation->throwException();
            }

            $message = GlobalComments_Comment::create($values);
            $message->save($values);

            $response['success'] = "–£—Å–ø–µ—Ö";

            $this->ajaxResponse($response);
        } catch (Exception $ex) {
            $this->ajaxError($ex);
        }
    }

    private static function initListServices($cart)
    {
        $list = "";

        $data = self::getCalculatorData();
        $services = [];
        $totalPrice = 0;

        foreach ($data as $item) {
            foreach ($item->services as $service) {
                $services[$service->code] = $service;
            }
        }

        foreach ($cart as $cartItem) {
            $device = $cartItem['deviceName'];
            $deviceServices = "";

            if (isset($cartItem['services']) && $cartItem['services']) {
                foreach ($cartItem['services'] as $key => $service) {
                    $serviceData = explode('~', $service['code']);

                    $code = $serviceData[0];
                    $segment = $serviceData[1];
                    $index = $serviceData[2];

                    $nameService = $services[$code]->name;
                    $nameSegment = $services[$code]->segments[$segment]->prices[$index]->name;
                    $price = $services[$code]->segments[$segment]->prices[$index]->price;

                    $totalPrice += $price;

                    $segmentService = self::$types[$segment]->name . ' - ' . $nameSegment . ' - ' . $price . ' —Ä—É–±.';

                    $deviceServices .= ($key + 1) . '. ' . $nameService . PHP_EOL . $segmentService . PHP_EOL . PHP_EOL;
                }
            }

            $list .= ">>> " . $device . " <<<" . PHP_EOL . $deviceServices . PHP_EOL;
        }

        return $list . "–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: " . $totalPrice . ' —Ä—É–±.';
    }

    public static function prefixService($type)
    {
        return self::$types[$type]->icon . ' ' . self::$types[$type]->name . ' - ';
    }

    private static function getCalculatorData()
    {
        ////////////////////////// –°–ú–ê–†–¢–§–û–ù
        // >>> –ü–õ–Å–ù–ö–ò
        // premium
        $pricePhoneFilmHDPremium = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1500];
        $pricePhoneFilmMattePremium = (object)['name' => '–º–∞—Ç–æ–≤–∞—è', 'price' => 1500];
        $pricePhoneFilmPrivacyHDPremium = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 2000];
        $pricePhoneFilmPrivacyMattePremium = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–∞—è', 'price' => 2000];

        // standart
        $pricePhoneFilmHDStandart = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1300];
        $pricePhoneFilmMatteStandart = (object)['name' => '–º–∞—Ç–æ–≤–∞—è', 'price' => 1500];
        $pricePhoneFilmPrivacyHDStandart = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1400, 'hidden' => true];
        $pricePhoneFilmPrivacyMatteStandart = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–∞—è', 'price' => 1400, 'hidden' => true];

        // base
        $pricePhoneFilmHDBase = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 700];
        $pricePhoneFilmMatteBase = (object)['name' => '–º–∞—Ç–æ–≤–∞—è', 'price' => 800];
        $pricePhoneFilmPrivacyHDBase = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 900, 'hidden' => true];
        $pricePhoneFilmPrivacyMatteBase = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–∞—è', 'price' => 900, 'hidden' => true];


        // >>> –°–¢–Å–ö–õ–ê –≠–ö–†–ê–ù
        // premium
        $pricePhoneGlassHDPremium = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–æ–µ', 'price' => 1300];
        $pricePhoneGlassMattePremium = (object)['name' => '–º–∞—Ç–æ–≤–æ–µ', 'price' => 1400, 'hidden' => true];
        $pricePhoneGlassPrivacyHDPremium = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–æ–µ', 'price' => 1600];
        $pricePhoneGlassPrivacyMattePremium = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–æ–µ', 'price' => 1500, 'hidden' => true];

        // standart
        $pricePhoneGlassHDStandart = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–æ–µ', 'price' => 900];
        $pricePhoneGlassMatteStandart = (object)['name' => '–º–∞—Ç–æ–≤–æ–µ', 'price' => 900, 'hidden' => true];
        $pricePhoneGlassPrivacyHDStandart = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–æ–µ', 'price' => 1100, 'hidden' => true];
        $pricePhoneGlassPrivacyMatteStandart = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–æ–µ', 'price' => 1100, 'hidden' => true];

        // base
        $pricePhoneGlassHDBase = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–æ–µ', 'price' => 550];
        $pricePhoneGlassMatteBase = (object)['name' => '–º–∞—Ç–æ–≤–æ–µ', 'price' => 550, 'hidden' => true];
        $pricePhoneGlassPrivacyHDBase = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–æ–µ', 'price' => 800, 'hidden' => true];
        $pricePhoneGlassPrivacyMatteBase = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–æ–µ', 'price' => 800, 'hidden' => true];


        // >>> –°–¢–Å–ö–õ–ê –ù–ê –ö–ê–ú–ï–†–£
        // premium
        $pricePhoneGlassCameraFullPremium = (object)['name' => '–ø–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞', 'price' => 1000, 'hidden' => true];
        $pricePhoneGlassCameraLensesPremium = (object)['name' => '–∑–∞—â–∏—Ç–∞ –ª–∏–Ω–∑', 'price' => 1000, 'hidden' => true];

        // standart
        $pricePhoneGlassCameraFullStandart = (object)['name' => '–ø–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞', 'price' => 450, 'hidden' => true];
        $pricePhoneGlassCameraLensesStandart = (object)['name' => '–∑–∞—â–∏—Ç–∞ –ª–∏–Ω–∑', 'price' => 450, 'hidden' => true];

        // base
        $pricePhoneGlassCameraFullBase = (object)['name' => '–ø–æ–ª–Ω–∞—è –∑–∞—â–∏—Ç–∞', 'price' => 250];
        $pricePhoneGlassCameraLensesBase = (object)['name' => '–∑–∞—â–∏—Ç–∞ –ª–∏–Ω–∑', 'price' => 300];


        ////////////////////////// –ü–õ–ê–ù–®–ï–¢
        // >>> –ü–õ–Å–ù–ö–ò
        // premium
        $priceTabletFilmHDPremium = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 2000];
        $priceTabletFilmMattePremium = (object)['name' => '–º–∞—Ç–æ–≤–∞—è', 'price' => 2000];
        $priceTabletFilmPrivacyHDPremium = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 2900];
        $priceTabletFilmPrivacyMattePremium = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–∞—è', 'price' => 2900];

        // standart
        $priceTabletFilmHDStandart = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1100];
        $priceTabletFilmMatteStandart = (object)['name' => '–º–∞—Ç–æ–≤–∞—è', 'price' => 1100, 'hidden' => true];
        $priceTabletFilmPrivacyHDStandart = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1900, 'hidden' => true];
        $priceTabletFilmPrivacyMatteStandart = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–∞—è', 'price' => 1900, 'hidden' => true];

        // base
        $priceTabletFilmHDBase = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 650];
        $priceTabletFilmMatteBase = (object)['name' => '–º–∞—Ç–æ–≤–∞—è', 'price' => 650];
        $priceTabletFilmPrivacyHDBase = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1200];
        $priceTabletFilmPrivacyMatteBase = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–∞—è', 'price' => 1200];


        ////////////////////////// –°–ú–ê–†–¢-–ß–ê–°–´
        // >>> –ü–õ–Å–ù–ö–ò
        // premium
        $priceWatchFilmHDPremium = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1300];
        $priceWatchFilmMattePremium = (object)['name' => '–º–∞—Ç–æ–≤–∞—è', 'price' => 1300];
        $priceWatchFilmPrivacyHDPremium = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 2900];
        $priceWatchFilmPrivacyMattePremium = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–∞—è', 'price' => 2900];

        // standart
        $priceWatchFilmHDStandart = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1300];
        $priceWatchFilmMatteStandart = (object)['name' => '–º–∞—Ç–æ–≤–∞—è', 'price' => 1500];
        $priceWatchFilmPrivacyHDStandart = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1900, 'hidden' => true];
        $priceWatchFilmPrivacyMatteStandart = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–∞—è', 'price' => 1900, 'hidden' => true];

        // base
        $priceWatchFilmHDBase = (object)['name' => '–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 700];
        $priceWatchFilmMatteBase = (object)['name' => '–º–∞—Ç–æ–≤–∞—è', 'price' => 800, 'hidden' => true];
        $priceWatchFilmPrivacyHDBase = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–≥–ª—è–Ω—Ü–µ–≤–∞—è', 'price' => 1200, 'hidden' => true];
        $priceWatchFilmPrivacyMatteBase = (object)['name' => '–∞–Ω—Ç–∏—à–ø–∏–æ–Ω-–º–∞—Ç–æ–≤–∞—è', 'price' => 1200, 'hidden' => true];


        // –°–ï–ì–ú–ï–ù–¢–´ - –°–ú–ê–†–¢–§–û–ù
        $phoneFilmSegments = [
            'premium' => (object)[
                'hidden' => true,
                'prices' => [$pricePhoneFilmHDPremium, $pricePhoneFilmMattePremium, $pricePhoneFilmPrivacyHDPremium, $pricePhoneFilmPrivacyMattePremium]
            ],
            'standart' => (object)[
                'hidden' => false,
                'prices' => [$pricePhoneFilmHDStandart, $pricePhoneFilmMatteStandart, $pricePhoneFilmPrivacyHDStandart, $pricePhoneFilmPrivacyMatteStandart]

            ],
            'base' => (object)[
                'hidden' => false,
                'prices' => [$pricePhoneFilmHDBase, $pricePhoneFilmMatteBase, $pricePhoneFilmPrivacyHDBase, $pricePhoneFilmPrivacyMatteBase]
            ],
        ];

        $phoneGlassSegments = [
            'premium' => (object)[
                'hidden' => false,
                'prices' => [$pricePhoneGlassHDPremium, $pricePhoneGlassMattePremium, $pricePhoneGlassPrivacyHDPremium, $pricePhoneGlassPrivacyMattePremium]
            ],
            'standart' => (object)[
                'hidden' => false,
                'prices' => [$pricePhoneGlassHDStandart, $pricePhoneGlassMatteStandart, $pricePhoneGlassPrivacyHDStandart, $pricePhoneGlassPrivacyMatteStandart]

            ],
            'base' => (object)[
                'hidden' => false,
                'prices' => [$pricePhoneGlassHDBase, $pricePhoneGlassMatteBase, $pricePhoneGlassPrivacyHDBase, $pricePhoneGlassPrivacyMatteBase]
            ],
        ];

        $phoneGlassCameraSegments = [
            'premium' => (object)[
                'hidden' => false,
                'prices' => [$pricePhoneGlassCameraFullPremium, $pricePhoneGlassCameraLensesPremium]
            ],
            'standart' => (object)[
                'hidden' => false,
                'prices' => [$pricePhoneGlassCameraFullStandart, $pricePhoneGlassCameraLensesStandart]

            ],
            'base' => (object)[
                'hidden' => false,
                'prices' => [$pricePhoneGlassCameraFullBase, $pricePhoneGlassCameraLensesBase]
            ],
        ];


        // –°–ï–ì–ú–ï–ù–¢–´ - –ü–õ–ê–ù–®–ï–¢
        $tabletFilmSegments = [
            'premium' => (object)[
                'hidden' => true,
                'prices' => [$priceTabletFilmHDPremium, $priceTabletFilmMattePremium, $priceTabletFilmPrivacyHDPremium, $priceTabletFilmPrivacyMattePremium]
            ],
            'standart' => (object)[
                'hidden' => false,
                'prices' => [$priceTabletFilmHDStandart, $priceTabletFilmMatteStandart, $priceTabletFilmPrivacyHDStandart, $priceTabletFilmPrivacyMatteStandart]
            ],
            // 'base' => (object)[
            //     'hidden' => false,
            //     'prices' => [$pricePhoneFilmHDBase, $pricePhoneFilmMatteBase, $pricePhoneFilmPrivacyHDBase, $pricePhoneFilmPrivacyMatteBase]
            // ],
        ];

        // –°–ï–ì–ú–ï–ù–¢–´ - –°–ú–ê–†–¢-–ß–ê–°–´
        $watchFilmSegments = [
            'premium' => (object)[
                'hidden' => true,
                'prices' => [$priceWatchFilmHDPremium, $priceWatchFilmMattePremium, $priceWatchFilmPrivacyHDPremium, $priceWatchFilmPrivacyMattePremium]
            ],
            'standart' => (object)[
                'hidden' => false,
                'prices' => [$priceWatchFilmHDStandart, $priceWatchFilmMatteStandart, $priceWatchFilmPrivacyHDStandart, $priceWatchFilmPrivacyMatteStandart]
            ],
            'base' => (object)[
                'hidden' => false,
                'prices' => [$priceWatchFilmHDBase, $priceWatchFilmMatteBase, $priceWatchFilmPrivacyHDBase, $priceWatchFilmPrivacyMatteBase]
            ],
        ];


        // –î–ê–ù–ù–´–ï - –°–ú–ê–†–¢–§–û–ù
        $phone = (object)[
            'id' => 'phone',
            'services' => [
                (object)[
                    'name' => '–ü–ª—ë–Ω–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω',
                    'code' => 'film-glass-phone',
                    'hidden' => false,
                    'segments' => $phoneFilmSegments
                ],
                (object)[
                    'name' => '–ü–ª—ë–Ω–∫–∞ –Ω–∞ –∑–∞–¥–Ω—é—é –ø–∞–Ω–µ–ª—å',
                    'code' => 'film-back-phone',
                    'hidden' => false,
                    'segments' => $phoneFilmSegments
                ],
                (object)[
                    'name' => '–°—Ç–µ–∫–ª–æ –Ω–∞ —ç–∫—Ä–∞–Ω',
                    'code' => 'glass-phone',
                    'hidden' => false,
                    'segments' => $phoneGlassSegments
                ],
                (object)[
                    'name' => '–°—Ç–µ–∫–ª–æ –Ω–∞ –∫–∞–º–µ—Ä—É',
                    'code' => 'glass-camera-phone',
                    'hidden' => false,
                    'segments' => $phoneGlassCameraSegments
                ],
            ],
        ];

        // –î–ê–ù–ù–´–ï - –ü–õ–ê–ù–®–ï–¢
        $tablet = (object)[
            'id' => 'tablet',
            'services' => [
                (object)[
                    'name' => '–ü–ª—ë–Ω–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω',
                    'code' => 'film-glass-tablet',
                    'hidden' => false,
                    'segments' => $tabletFilmSegments
                ],
                // (object)[
                //     'name' => '–ü–ª—ë–Ω–∫–∞ –Ω–∞ –∑–∞–¥–Ω—é—é –ø–∞–Ω–µ–ª—å',
                //     'code' => 'film-back-table',
                //     'hidden' => false,
                //     'segments' => $tableFilmSegments
                // ],
                // (object)[
                //     'name' => '–°—Ç–µ–∫–ª–æ –Ω–∞ —ç–∫—Ä–∞–Ω',
                //     'code' => 'glass-table',
                //     'hidden' => false,
                //     'segments' => $tableGlassSegments
                // ],
                // (object)[
                //     'name' => '–°—Ç–µ–∫–ª–æ –Ω–∞ –∫–∞–º–µ—Ä—É',
                //     'code' => 'glass-camera-table',
                //     'hidden' => false,
                //     'segments' => $tableGlassCameraSegments
                // ],
            ],
        ];


        // –î–ê–ù–ù–´–ï - –°–ú–ê–†–¢-–ß–ê–°–´
        $watch = (object)[
            'id' => 'watch',
            'services' => [
                (object)[
                    'name' => '–ü–ª—ë–Ω–∫–∞ –Ω–∞ —ç–∫—Ä–∞–Ω',
                    'code' => 'film-glass-watch',
                    'hidden' => false,
                    'segments' => $watchFilmSegments
                ],
                // (object)[
                //     'name' => '–ü–ª—ë–Ω–∫–∞ –Ω–∞ –∑–∞–¥–Ω—é—é –ø–∞–Ω–µ–ª—å',
                //     'code' => 'film-back-table',
                //     'hidden' => false,
                //     'segments' => $tableFilmSegments
                // ],
                // (object)[
                //     'name' => '–°—Ç–µ–∫–ª–æ –Ω–∞ —ç–∫—Ä–∞–Ω',
                //     'code' => 'glass-table',
                //     'hidden' => false,
                //     'segments' => $tableGlassSegments
                // ],
                // (object)[
                //     'name' => '–°—Ç–µ–∫–ª–æ –Ω–∞ –∫–∞–º–µ—Ä—É',
                //     'code' => 'glass-camera-table',
                //     'hidden' => false,
                //     'segments' => $tableGlassCameraSegments
                // ],
            ],
        ];

        return [$phone, $tablet, $watch];
    }
}
